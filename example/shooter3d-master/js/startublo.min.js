var bood={Version:"0.0.0.1",MaxWidth:1024,MaxHeight:576,AspectRation:[16,9],_fullScreen:false,_pause:true,_frags:0,init:function(){this.createScene();this.addPlayer();this._resourcesCounter=5;this.createWave({count:this._resourcesCounter,type:"monster"});var a=setInterval(function(){var e=0;if(bood._wave!=undefined&&bood._wave.items!=undefined){for(var d=0,b=bood._wave.items.length;d<b;d++){if(bood._wave.items[d]._loaded){e++}}}if(e==bood._resourcesCounter){clearInterval(a);document.getElementById("loadingTitle").style.display="none";document.getElementById("startBtn").style.display="block";bood.bindMouse();bood.bindKeyboard()}},100)},bindMouse:function(){window.onmousemove=function(d){var a=d.clientX,f=d.clientY,c=Math.PI*2,b=Math.PI/2;a-=Math.round(window.innerWidth/2)-Math.round(bood._w/2);bood._aX=c/2/1024*a+c/4;if(a<0){bood._aX=c/4}if(a>bood._w){bood._aX=-c/4}if(bood._player._mesh!==undefined){bood._player._mesh.rotation.y=-bood._aX+Math.PI}f-=Math.round(window.innerHeight/2)-Math.round(bood._h/2);bood._aY=b/4/576*f-b/6;if(f<0){bood._aY=-b/6}if(f>bood._h){bood._aY=b/12}};bood._wrap.onclick=function(a){bood._player.setAnimation("fire");if(bood._bullets==undefined){bood._bullets=[]}bood._bullets.push(new boodBullet());a.preventDefault()};document.getElementById("startBtn").onclick=function(a){a.preventDefault();document.getElementById("bg").style.display="none";document.getElementById("startBtn").style.display="none";document.getElementById("continueBtn").style.display="none";bood._pause=false;bood.animate()};document.getElementById("continueBtn").onclick=function(a){a.preventDefault();bood.pause()};document.getElementById("restartBtn").onclick=function(c){c.preventDefault();bood._player._health=100;bood._frags=0;document.getElementById("health").innerHTML=bood._player._health;document.getElementById("frags").innerHTML=bood._frags;if(bood._wave!=undefined&&bood._wave.items!=undefined){for(var b=0,a=bood._wave.items.length;b<a;b++){bood._wave.items[b].reset()}}document.getElementById("gameover").style.display="none";bood.pause()}},bindKeyboard:function(){this._keyDownList=[];window.onkeydown=function(a){bood._keyDownList[a.keyCode]=true;if(a.keyCode==80||a.keyCode==27){bood.pause()}if(a.keyCode==70){bood.fullScreen()}};window.onkeyup=function(a){bood._keyDownList[a.keyCode]=false}},fullScreen:function(){this._fullScreen=!this._fullScreen;this.updateSceneSize()},pause:function(){this._pause=!this._pause;if(!this._pause){document.getElementById("bg").style.display="none";document.getElementById("continueBtn").style.display="none";this._clock.start();this.animate()}else{document.getElementById("bg").style.display="block";document.getElementById("continueBtn").style.display="block"}},gameOver:function(){this._pause=true;setTimeout(function(){document.getElementById("blood").style.opacity=0.8},150);setTimeout(function(){document.getElementById("gameover").style.display="block";document.getElementById("blood").style.opacity=0},2000)},animate:function(){if(!bood._pause){requestAnimationFrame(bood.animate)}else{bood._clock.stop();return this}var e=bood._clock.getDelta();bood._player.process(e);if(bood._wave!=undefined&&bood._wave.items!=undefined){for(var c=0,a=bood._wave.items.length;c<a;c++){bood._wave.items[c].process(e)}}if(bood._bullets!=undefined){for(var c=0,a=bood._bullets.length;c<a;c++){if(bood._bullets[c]!=undefined){bood._bullets[c].process(e)}}}var d=Date.now()*0.00005;for(c=0;c<bood.scene.children.length;c++){var b=bood.scene.children[c];if(b instanceof THREE.ParticleSystem){b.rotation.y=d*(c<4?c+1:-(c+1))}}bood.setCameraPos();bood.renderer.render(bood.scene,bood.camera)},addPlayer:function(){this._player=new boodPlayer({type:"human",name:"Ironman"})},createWave:function(b){var d=b||{};this._wave={count:d.count||1,type:d.type||"monster",items:[]};for(var c=0,a=this._wave.count;c<a;c++){this._wave.items.push(new boodKiller({type:this._wave.type,index:c}))}},createScene:function(){this._wrap=document.getElementById("wrap");this.renderer=new THREE.WebGLRenderer({antialias:true,autoClear:true,clearColor:15724527,clearAlpha:1});this._wrap.appendChild(this.renderer.domElement);this._loader=new THREE.p5dLoader();this._loadedModels={};this._clock=new THREE.Clock();this._radius=90;this._radiusDelta=0;this.lookPosition=new THREE.Vector3(0,0,80);this.camera=new THREE.PerspectiveCamera(60,1024/576,10,6000);this.camera.up=new THREE.Vector3(0,0,1);this._aX=0;this._aY=Math.PI/12;this.scene=new THREE.Scene();this.scene.fog=new THREE.FogExp2(15724527,0.0008,3000);this.light=new THREE.HemisphereLight(16777215,0,1.8);this.light.up=new THREE.Vector3(0,0,1);this.light.position.set(-500,-500,3000);this.scene.add(this.light);this.scene.add(new THREE.AmbientLight(0));var e="/m/cube/",d=".jpg",c=[e+"px"+d,e+"nx"+d,e+"py"+d,e+"ny"+d,e+"pz"+d,e+"nz"+d];this.reflectionCube=THREE.ImageUtils.loadTextureCube(c);this.reflectionCube.format=THREE.RGBFormat;var b,a=THREE.ImageUtils.loadTexture("data/ground/ground_snow.jpg");a.wrapS=a.wrapT=THREE.RepeatWrapping;a.repeat.set(40,40);b=new THREE.Mesh(new THREE.PlaneGeometry(6000,6000,1,1),new THREE.MeshBasicMaterial({map:a}));b.doubleSided=true;b.receiveShadow=true;this.scene.add(b);this.renderer.gammaInput=true;this.renderer.gammaOutput=true;this.renderer.physicallyBasedShading=true;bood.utils.getModel("data/trees/tree.js","data/trees",function(n){n.scale.set(150,150,150);n.position.set(300,-800,0);n.rotation.x=Math.PI/2;n.rotation.y=Math.PI;n.matrixAutoUpdate=false;n.updateMatrix();bood.scene.add(n);for(var m=0,j=30;m<j;m++){var k=n.clone(),r=Math.random()*Math.PI*2,u=Math.random()*100+50,h=Math.sin(r),q=Math.cos(r),g=Math.sin(0),p=Math.cos(0),f=h*p,t=q*p,o=Math.round(Math.random()*1000+500);k.position.set(o*f,o*t,0);k.rotation.y=Math.random()*Math.PI*3;k.scale.set(u,u,u);k.matrixAutoUpdate=false;k.updateMatrix();bood.scene.add(k)}});this.addSnow();this.setCameraPos();this.updateSceneSize();window.addEventListener("resize",function(){bood.updateSceneSize()})},addSnow:function(){this._snowGeometry=new THREE.Geometry();for(var g,d=0;d<20000;d++){g=new THREE.Vector3();g.x=Math.random()*2000-1000;g.y=Math.random()*2000-1000;g.z=Math.random()*2000-1000;this._snowGeometry.vertices.push(g)}var a=[],f,c,b,e=[[[1,1,1],1],[[1,1,1],1],[[1,1,1],1],[[1,1,1],2],[[1,1,1],1]];for(d=0;d<e.length;d++){c=e[d][1];b=e[d][0];a[d]=new THREE.ParticleBasicMaterial({size:c});a[d].color.setHSV(b[0],b[1],b[2]);f=new THREE.ParticleSystem(this._snowGeometry,a[d]);f.rotation.x=Math.random()*6;f.rotation.y=Math.random()*6;f.rotation.z=Math.random()*6;this.scene.add(f)}},setCameraPos:function(a,g){this._aX=a||this._aX||0;this._aY=g||this._aY||0;var e=Math.sin(this._aX+Math.PI),f=Math.cos(this._aX+Math.PI),b=Math.sin(this._aY),d=Math.cos(this._aY),c=this.lookPosition.z+this._radius*b;if(c<1){c=1}this.camera.position.set(this.lookPosition.x+this._radius*e*d,this.lookPosition.y+this._radius*f*d,c);this.camera.lookAt(this.lookPosition)},updateSceneSize:function(){this._wrap.style.display="none";var b=window.innerHeight,a=window.innerWidth;if(!this._fullScreen){if(a/this.AspectRation[0]>b/this.AspectRation[1]){a=Math.round(b/this.AspectRation[1]*this.AspectRation[0]);b=Math.round(a/this.AspectRation[0]*this.AspectRation[1])}else{b=Math.round(a/this.AspectRation[0]*this.AspectRation[1]);a=Math.round(b/this.AspectRation[1]*this.AspectRation[0])}if(a>this.MaxWidth){a=this.MaxWidth;b=Math.round(a/this.AspectRation[0]*this.AspectRation[1])}}this._w=a;this._h=b;this._wrap.style.left=Math.round((document.width-a)/2)+"px";this._wrap.style.top=Math.round((document.height-b)/2)+"px";this._wrap.style.width=a+"px";this._wrap.style.height=b+"px";this._wrap.style.display="block";this.renderer.setSize(a,b);this.camera.aspect=a/b;this.camera.updateProjectionMatrix()},clearBullets:function(){for(var b=0,a=this._bullets.length;b<a;b++){if(this._bullets[b]._destroy!==undefined){this._bullets.splice(b,1);this.clearBullets();break}}},utils:{getModel:function(a,c,e){var d=new XMLHttpRequest();d.onreadystatechange=b;function b(){if(d.readyState<4){return}if(d.status!==200){return}if(d.readyState===4){var f=bood._loader.createModel(JSON.parse(d.response),c);e(new THREE.Mesh(f[0],new THREE.MeshFaceMaterial(f[1])))}}d.open("GET",a,true);d.send("")}}};var boodPlayer=function(b){var c=b||{};this._type=c.type||"human";this._health=c.health||100;this._speed=c.speed||1;document.getElementById("health").innerHTML=this._health;var a=this;bood.utils.getModel("data/guns/weapon1.js","data/guns",function(e){a._mesh=e;a._mesh.material.materials[0].metal=true;a._mesh.material.materials[0].shininess=15;a._mesh.scale.set(50,50,50);a._mesh.rotation.x=Math.PI/2;a._mesh.rotation.y=Math.PI;bood.scene.add(a._mesh)});this._animations={idle:{time:0},fire:{time:0.2}};this.setAnimation("idle")};boodPlayer.prototype={constructor:boodPlayer,healthUp:function(a){this._health+=a||1},healthDown:function(a){this._health-=a||1;if(this._health<=0){this._health=0;bood.gameOver()}document.getElementById("health").innerHTML=Math.round(this._health)},setAnimation:function(a){if(a!==this._animationName){this._animationName=a;this._animationTime=0}},process:function(a){if(this._mesh==undefined){return this}switch(this._animationName){case"idle":this._mesh.rotation.x=Math.PI/2;break;case"fire":this._animationTime+=a;bood._aY+=a*0.12;if(this._animationTime>this._animations[this._animationName].time){this.setAnimation("idle")}break}}};var boodKiller=function(a){var c=a||{};this._index=c.index;this._type=c.type||"human";this._health=c.health||200;this._speed=c.speed||140;this._angle=Math.random()*Math.PI-Math.PI/2+Math.PI;this._distance=600+Math.round(Math.random()*300);var e=Math.sin(this._angle),f=Math.cos(this._angle),b=Math.sin(0),d=Math.cos(0);this._ax=e*d;this._ay=f*d;this._animations={idle:{time:0},attack:{time:1,},crdeath:{time:0.6}};this.load({skin:Math.round(Math.random()*4),weapon:0})};boodKiller.prototype={constructor:boodKiller,load:function(b){var e=b||{},d,a=this,c={baseUrl:"data/killers/ratamahatta/",body:"ratamahatta.js",skins:["ratamahatta.png","ctf_b.png","ctf_r.png","dead.png","gearwhore.png"],weapons:[["w_hyperblaster.js","w_hyperblaster.png"]]};this._character=new THREE.MD2Character();this._character.scale=2;this._character.onLoadComplete=function(){a._character.setWeapon(e.weapon||0);a._character.setSkin(e.skin||0);a._mesh=a._character.root;a._mesh.position.set(a._distance*a._ax,a._distance*a._ay,47);a._mesh.rotation.x=Math.PI/2;a._mesh.rotation.y=-a._angle;bood.scene.add(a._mesh);a.setAnimation("run");a._loaded=true};this._character.loadParts(c)},healthUp:function(a){this.params.health+=a||1},healthDown:function(a){this.params.health-=a||1},setAnimation:function(a){if(a!==this._animationName){this._animationName=a;this._animationTime=0;this._character.setAnimation(this._animationName)}},attack:function(){this.destroy()},destroy:function(){this._destroy=true;bood.scene.remove(this._mesh);bood.renderer.deallocateObject(this._mesh);console.log("killer destroy complete",this._index)},reset:function(){this._angle=Math.random()*Math.PI-Math.PI/2+Math.PI;this._distance=500+Math.round(Math.random()*100);var c=Math.sin(this._angle),d=Math.cos(this._angle),a=Math.sin(0),b=Math.cos(0);this._ax=c*b;this._ay=d*b;this._mesh.rotation.y=-this._angle;this.setAnimation("run")},process:function(a){if(this._destroy==true){return this}switch(this._animationName){case"run":this._character.update(a);this._distance-=a*this._speed;this._mesh.position.x=this._distance*this._ax;this._mesh.position.y=this._distance*this._ay;if(this._distance<150){this.setAnimation("attack")}break;case"idle":this._character.update(a);break;case"attack":this._animationTime+=a;if(this._animationTime>this._animations[this._animationName].time){bood._player.healthDown(a*2);document.getElementById("blood").style.opacity=0.5;setTimeout(function(){document.getElementById("blood").style.opacity=0},100)}this._character.update(a);break;case"crdeath":this._animationTime+=a;if(this._animationTime<this._animations[this._animationName].time){this._character.update(a)}if(this._animationTime>2){this.reset()}break;case"fire":this._animationTime+=a;bood._aY+=a*0.08;if(this._animationTime>this._animations[this._animationName].time){this.setAnimation("idle")}break}}};var boodBullet=function(a){var c=a||{};this._type=c.type||"t1";this._speed=c.speed||800;this._angle=bood._aX;this._distance=100;this._s=1;var e=Math.sin(this._angle),f=Math.cos(this._angle),b=Math.sin(0),d=Math.cos(0);this._ax=e*d;this._ay=f*d;this._mesh=new THREE.Mesh(new THREE.CubeGeometry(2,2,2),new THREE.MeshBasicMaterial({color:16711680}));this._mesh.position.set(this._distance*this._ax,this._distance*this._ay,70);this._mesh.rotation.y=-this._angle;bood.scene.add(this._mesh);this._animations={fly:{time:0},fire:{time:0.2}};this.setAnimation("fly")};boodBullet.prototype={constructor:boodBullet,setAnimation:function(a){if(a!==this._animationName){this._animationName=a;this._animationTime=0}},destroy:function(){this._destroy=true;bood.scene.remove(this._mesh);bood.renderer.deallocateObject(this._mesh);bood.clearBullets()},process:function(c){if(this._destroy!==undefined){return this}switch(this._animationName){case"fly":this._distance+=c*this._speed;this._mesh.position.set(this._distance*this._ax,this._distance*this._ay,70);if(bood._wave!=undefined&&bood._wave.items!=undefined){for(var b=0,a=bood._wave.items.length;b<a;b++){if(bood._wave.items[b]._animationName!="crdeath"){if(this._angle-0.2<=bood._wave.items[b]._angle&&this._angle+0.2>=bood._wave.items[b]._angle&&this._distance-50<=bood._wave.items[b]._distance&&this._distance+50>=bood._wave.items[b]._distance){bood._wave.items[b].setAnimation("crdeath");bood._frags++;document.getElementById("frags").innerHTML=bood._frags;this.setAnimation("fire")}}}}if(this._distance>1000){this.destroy()}break;case"fire":this._animationTime+=c;this._s+=c*15;this._mesh.scale.set(this._s,this._s,this._s);if(this._animationTime>this._animations[this._animationName].time){this.destroy()}break}}};